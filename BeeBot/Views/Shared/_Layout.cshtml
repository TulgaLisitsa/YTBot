<!DOCTYPE html>
<html lang="EN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YTBot - Your Twitch bot, made simple!</title>
    @Styles.Render("~/Content/css")
    @Scripts.Render("~/bundles/modernizr")
    @Scripts.Render("~/bundles/jquery")
    
    @Scripts.Render("~/bundles/bootstrap")
    @Scripts.Render("~/bundles/signalr")
    
    <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.0.2/dist/loadingoverlay.min.js"></script>
    
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <script src="~/Scripts/Signalr.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600' rel='stylesheet' type='text/css'>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>


</head>
<body>



    <div class="container-fluid">
        <div class="row d-flex d-md-block flex-nowrap wrapper">
            <div class="col-md-3 float-left col-1 pl-0 pr-0 collapse width show" id="sidebar">
                <div class="list-group border-0 card text-center text-md-left">
                    <div class="text-center list-group-item d-inline-block collapsed">
                        <a href="@Url.Action("Index", "Home")" class="channelMenuHeader ">@Html.Action("ChannelName", "Home")</a>
                    </div>
                    <div class="text-center list-group-item d-lg-inline-block collapsed">
                        <div class="botstatus">
                            <p style="display: inline !important;"><i class="fa fa-spinner fa-spin statusloader"></i> <span class="botconnectionstatus badge badge-info"></span></p>
                        </div>
                    </div>
                    <a href="#menu1" class="list-group-item d-inline-block collapsed" data-toggle="collapse" aria-expanded="false"><i class="fa fa-dashboard"></i> <span class="d-none d-md-inline">Home</span> </a>
                    <div class="collapse" id="menu1" data-parent="#sidebar">
                        <a href="@Url.Action("Preferences", "Home")" class="list-group-item"><i class="fa fa-cog"></i> Stream setup</a>
                        <a href="@Url.Action("Index", "Manage")" class="list-group-item"><i class="fa fa-user-circle"></i> User settings</a>

                        @if (Request.IsAuthenticated)
                        {
                            <a href="javascript:document.getElementById('logoutForm').submit()" class="list-group-item"><i class="fa fa-sign-out"></i>Log out</a>
                            using (Html.BeginForm("LogOff", "Account", FormMethod.Post, new { id = "logoutForm", @class = "navbar-right" }))
                            {
                                @Html.AntiForgeryToken()
                            }
                        }
                    </div>
                    <a href="@Url.Action("Control", "Home")" class="list-group-item d-inline-block collapsed menuButton" data-parent="#sidebar" id="controlbtn"><i class="fa fa-home"></i> <span class="d-none d-md-inline">Bot controls</span></a>
                    <a href="@Url.Action("Stream", "Home")" class="list-group-item d-inline-block collapsed menuButton" data-parent="#sidebar" id="streambtn"><i class="fa fa-chevron-circle-right"></i> <span class="d-none d-md-inline">Title and game</span></a>
                    <a href="@Url.Action("ChatOptions", "Home")" class="list-group-item d-inline-block collapsed menuButton" data-parent="#sidebar" id="chatoptbtn"><i class="fa fa-font"></i> <span class="d-none d-md-inline">Chat - banned words</span></a>
                    <a href="@Url.Action("ChatNStats", "Home")" class="list-group-item d-inline-block collapsed menuButton" data-parent="#sidebar" id="chatstatsbtn"><i class="fa fa-comments"></i> <span class="d-none d-md-inline">Chat - stats</span></a>
                    <a href="@Url.Action("SongRequests", "Home")" class="list-group-item d-inline-block collapsed menuButton" data-parent="#sidebar" id="songreqbtn"><i class="fa fa-music"></i> <span class="d-none d-md-inline">Songrequests</span></a>
                    <a href="@Url.Action("LoyaltyHtml", "Home")" class="list-group-item d-inline-block collapsed menuButton" data-parent="#sidebar" id="loyaltybtn"><i class="fa fa-money"></i> <span class="d-none d-md-inline">Loyalty</span></a>
                    <a href="@Url.Action("Triggers", "Home")" class="list-group-item d-inline-block collapsed menuButton" data-parent="#sidebar" id="triggerbtn"><i class="fa fa-exclamation-circle"></i> <span class="d-none d-md-inline">Triggers</span></a>
                    <a href="@Url.Action("Timers", "Home")" class="list-group-item d-inline-block collapsed menuButton" data-parent="#sidebar" id="timersbtn"><i class="fa fa-clock-o"></i> <span class="d-none d-md-inline">Timers</span></a>
                    <a href="@Url.Action("Polls", "Home")" class="list-group-item d-inline-block collapsed menuButton" data-parent="#sidebar" id="pollsbtn"><i class="fa fa-bar-chart"></i> <span class="d-none d-md-inline">Polls</span></a>

                    <div class="footer text-center" id="footer">
                        YTBot v.2.0 BETA &copy; @DateTime.Now.Year - BJSolutions
                    </div>
                </div>
            </div>
            <main class="col-md-9 float-left col pl-md-2 pt-2 main">
                <div>
                    <a href="#" data-target="#sidebar" data-toggle="collapse" class="pull-left"><i class="fa fa-navicon fa-2x py-2 p-1"></i></a>
                </div>

                <div class="page-header">

                </div>
                <div class="maincontent">
                    @RenderBody()
                </div>


                <div>


                </div>
            </main>

        </div>
    </div>

    @{
        if (Request.IsAuthenticated)
        {
            <script type="text/javascript">

                var botConnected = false;

                // Check bot status every 10 seconds
                setInterval(function () {
                    $.connection.twitchHub.server.botStatus("test", "test", "test");
                }, 10000);

                $.connection.twitchHub.client.BotStatus = function (connected) {
                    console.log("BotStatus: " + connected.info);
                    botConnected = connected.connected;
                    tryBotReconnectIfDisconnected();
                    $(".statusloader").addClass("dontshow");
                    $(".botconnectionstatus").text(connected.info);
                    if (connected.connected) {
                        $(".botconnectionstatus").removeClass("badge-info").removeClass("badge-danger").removeClass("badge-warning").addClass("badge-success");
                    } else {
                        
                        $(".botconnectionstatus").removeClass("badge-info").removeClass("badge-danger").removeClass("badge-success").addClass("badge-warning");
                    }
                };

                // try to reconnect on disconnect
                $.connection.hub.disconnected(function () {
                    $(".botconnectionstatus").text("Disconnected");
                    $(".botconnectionstatus").removeClass("badge-info").removeClass("badge-warning").removeClass("badge-success").addClass("badge-danger");
                    console.log("Disconnected from web-server...");
                    $.amaran({
                        'theme': 'colorful',
                        'content': {
                            bgcolor: '#ff3300',
                            color: '#fff',
                            message: "Disconnected from web-server...",
                        },
                        'closeOnClick': false,
                        'inEffect': 'slideTop'

                    });
                    setTimeout(function () {
                        tryReconnect();

                    }, 5000); // Restart connection after 5 seconds.
                });

                $.connection.hub.error(function (error) {
                    console.log('SignalR error: ' + error);
                });

                // Reconnect bot to Twitch if disconnected
                function tryBotReconnectIfDisconnected() {
                    try {
                        if (botConnected == false) {
                            $.connection.twitchHub.server.connectBot("@{Html.RenderAction("GetUsername", "Home");}", "@{Html.RenderAction("GetPassword", "Home");}", "@{Html.RenderAction("GetChannel", "Home");}");
                        }
                    } catch (e) {
                        $.amaran({
                            'theme': 'colorful',
                            'content': {
                                bgcolor: '#ff3300',
                                color: '#fff',
                                message: e,
                            },
                            'closeOnClick': false,
                            'inEffect': 'slideTop'

                        });
                    }
                }

                // Reconnect signalR if disconnected from web-server
                function tryReconnect() {
                    console.log("Reconnecting to web-server...");
                    try {
                            $.amaran({
                                'theme': 'colorful',
                                'content': {
                                    bgcolor: '#0099ff',
                                    color: '#fff',
                                    message: "Reconnecting to web-server...",
                                },
                                'closeOnClick': false,
                                'inEffect': 'slideTop'
                            });
                            $.connection.hub.start();
                    } catch (e) {
                        console.log("Error on trying to reconnect: " + e);
                        $.amaran({
                            'theme': 'colorful',
                            'content': {
                                bgcolor: '#ff3300',
                                color: '#fff',
                                message: e,
                            },
                            'closeOnClick': false,
                            'inEffect': 'slideTop'

                        });
                    }

                }

                function sleep(ms) {
                    return new Promise(resolve => setTimeout(resolve, ms));
                }
            </script>
        }
    }
    @*@RenderSection("scripts", required: true)*@

</body>
</html>